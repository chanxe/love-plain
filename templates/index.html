{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12 text-center mb-5">
        <h1 class="display-4 fw-bold text-danger">æ¬¢è¿å›åˆ°æˆ‘ä»¬çš„äºŒäººä¸–ç•Œ â¤ï¸</h1>
        <p class="lead text-muted">è®°å½•æ¯ä¸€ä¸ªå¿ƒåŠ¨ç¬é—´ï¼Œçè—æ¯ä¸€ä»½å›å¿†</p>
    </div>
</div>

<div class="row">
    <!-- çºªå¿µæ—¥æ¿å— -->
    <div class="col-md-4">
        <div class="card love-card mb-4 shadow-sm border-0 h-100">
            <div class="card-body text-center">
                <div class="mb-3 display-1">ğŸ“…</div>
                <h3 class="card-title">
                    çºªå¿µæ—¥ 
                    <span class="badge bg-light text-dark rounded-pill fs-6 align-middle" title="å½“å‰æ€»æ•°">
                        {{ total_count if total_count is defined else '?' }}
                    </span>
                </h3>
                <p class="card-text text-muted">ä¸è¦å¿˜è®°é‡è¦çš„æ—¥å­</p>
                <ul id="anniversary-list" class="list-group list-group-flush text-start mb-3">
                    {% for anniversary in anniversaries %}
                    <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent">
                        <div>
                            <strong>{{ anniversary.title }}</strong>
                            <div class="small text-muted">{{ anniversary.date }}</div>
                        </div>
                        <div>
                            <span class="badge bg-danger rounded-pill mb-1">{{ anniversary.days_count }} å¤©</span>
                            <a href="/anniversaries/delete/{{ anniversary.id }}" class="btn btn-sm btn-outline-secondary border-0 text-muted px-1">Ã—</a>
                        </div>
                    </li>
                    {% else %}
                    <li class="list-group-item text-muted bg-transparent text-center">æš‚æ— çºªå¿µæ—¥</li>
                    {% endfor %}
                </ul>
                
                <!-- æŸ¥çœ‹å…¨éƒ¨çºªå¿µæ—¥æŒ‰é’® -->
                <button id="showMoreBtn" class="btn btn-outline-secondary w-100 mb-2">
                    æŸ¥çœ‹å…¨éƒ¨ ({{ total_count }})
                </button>

                <!-- æ·»åŠ çºªå¿µæ—¥æŒ‰é’® -->
                <button id="addAnniversaryBtn" class="btn btn-outline-danger w-100">
                    + æ·»åŠ çºªå¿µæ—¥
                </button>
            </div>
        </div>
    </div>
    
    <!-- æ—¥å¸¸åŠ¨æ€æ¿å— -->
    <div class="col-md-4">
        <div class="card love-card mb-4 shadow-sm border-0 h-100">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-3 pb-2 border-bottom">
                    <div class="d-flex align-items-center">
                        <span class="me-2">ğŸ“</span>
                        <h5 class="mb-0 fw-bold">æ‹çˆ±æ—¥å¸¸</h5>
                    </div>
                    <span class="badge bg-warning text-dark" id="pinnedCountBadge">ç½®é¡¶ 0/3</span>
                </div>
                
                <!-- ç½®é¡¶æ—¥å¸¸åˆ—è¡¨ -->
                <div id="pinnedMomentsList" class="mb-3">
                    {% if pinned_moments %}
                        {% for moment in pinned_moments %}
                        <div class="card mb-2 pinned-moment-card border-warning" data-moment-id="{{ moment.id }}" style="cursor: pointer;" title="ç‚¹å‡»æŸ¥çœ‹å®Œæ•´å†…å®¹">
                            <div class="card-body p-2">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div class="d-flex align-items-center">
                                        <img src="{{ moment.user.avatar }}" class="rounded-circle me-2" width="30" height="30" alt="Avatar">
                                        <div>
                                            <h6 class="mb-0 small fw-bold">{{ moment.user.name }}</h6>
                                            <small class="text-muted">{{ moment.timestamp.strftime('%Y-%m-%d %H:%M') }}</small>
                                        </div>
                                    </div>
                                    <div class="d-flex gap-1">
                                        <span class="badge bg-warning text-dark">ğŸ“Œ ç½®é¡¶</span>
                                        <button class="btn btn-sm btn-outline-warning unpin-btn" title="å–æ¶ˆç½®é¡¶" data-moment-id="{{ moment.id }}">
                                            âœ•
                                        </button>
                                    </div>
                                </div>
                                <p class="mb-0 small" style="white-space: pre-wrap;">{{ moment.content[:100] }}{% if moment.content|length > 100 %}...{% endif %}</p>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center text-muted py-3 small">
                            æš‚æ— ç½®é¡¶æ—¥å¸¸ï¼Œç‚¹å‡»"å†™æ—¥è®°"åå¯ç½®é¡¶é‡è¦å†…å®¹
                        </div>
                    {% endif %}
                </div>
                
                <a href="/moments" class="btn btn-primary w-100">å†™æ—¥è®° / å‘åŠ¨æ€</a>
            </div>
        </div>
    </div>

    <!-- "çˆ±çš„ä¸€å¤©"æ¿å— -->
    <div class="col-md-4">
        <div class="card love-card mb-4 shadow-sm border-0 h-100">
            <div class="card-body">
                <!-- é¡¶éƒ¨èœå•æ  -->
                <div class="d-flex align-items-center justify-content-between mb-3 pb-2 border-bottom">
                    <div class="d-flex align-items-center">
                        <span class="me-2">ğŸ’•</span>
                        <h5 class="mb-0 fw-bold">çˆ±çš„ä¸€å¤©</h5>
                    </div>
                    <div class="d-flex gap-2">
                        <button id="refreshBroadcastBtn" class="btn btn-sm btn-outline-primary" title="åˆ·æ–°æ’­æŠ¥">
                            ğŸ”„ åˆ·æ–°
                        </button>
                        <button id="viewHistoryBtn" class="btn btn-sm btn-outline-secondary" title="æŸ¥çœ‹å†å²æ’­æŠ¥">
                            ğŸ“… å†å²
                        </button>
                    </div>
                </div>
                
                <!-- æ’­æŠ¥å†…å®¹ -->
                <div id="broadcastContent" class="mb-3" style="white-space: pre-wrap; line-height: 1.6; font-size: 0.95rem; min-height: 120px;"></div>
                <div id="broadcastLoading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="text-muted mt-2 small">æ­£åœ¨åŠ è½½...</p>
                </div>
                <div id="broadcastError" class="alert alert-danger d-none small">
                    <p class="mb-0">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</p>
                </div>
                
                <!-- æ“ä½œæŒ‰é’® -->
                <button id="playAudioBtn" class="btn btn-outline-secondary w-100">ğŸ”Š æ’­æ”¾è¯­éŸ³</button>
                <audio id="broadcastAudio" controls class="w-100 d-none mt-2"></audio>
            </div>
        </div>
    </div>
</div>

<!-- Modal: æŸ¥çœ‹å…¨éƒ¨çºªå¿µæ—¥ -->
<div class="modal fade" id="allAnniversariesModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">å…¨éƒ¨çºªå¿µæ—¥</h5>
                <div class="ms-auto me-2">
                    <select id="sortOrder" class="form-select form-select-sm">
                        <option value="desc">æ·»åŠ æ—¶é—´å€’åº</option>
                        <option value="asc">æ·»åŠ æ—¶é—´æ­£åº</option>
                    </select>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="allAnniversariesList" class="list-group list-group-flush">
                    <!-- Content loaded via JS -->
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <button id="prevPage" class="btn btn-sm btn-outline-secondary" disabled>ä¸Šä¸€é¡µ</button>
                <span id="pageInfo" class="small text-muted">ç¬¬ 1 é¡µ</span>
                <button id="nextPage" class="btn btn-sm btn-outline-secondary" disabled>ä¸‹ä¸€é¡µ</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: æ·»åŠ çºªå¿µæ—¥ -->
<div class="modal fade" id="addAnniversaryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">æ·»åŠ çºªå¿µæ—¥</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="/anniversaries/add" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">æ ‡é¢˜</label>
                        <input type="text" name="title" class="form-control" placeholder="ä¾‹å¦‚ï¼šåœ¨ä¸€èµ·" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">æ—¥æœŸ</label>
                        <input type="date" name="date" class="form-control" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-danger">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal: æŸ¥çœ‹å†å²æ’­æŠ¥ -->
<div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ğŸ“… çˆ±çš„ä¸€å¤©å†å²æ’­æŠ¥</h5>
                <div class="ms-auto me-2 d-flex gap-2">
                    <select id="historySortOrder" class="form-select form-select-sm">
                        <option value="desc">æ—¶é—´å€’åº</option>
                        <option value="asc">æ—¶é—´æ­£åº</option>
                    </select>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <input type="text" id="historySearchInput" class="form-control" placeholder="æœç´¢æ’­æŠ¥å†…å®¹...">
                </div>
                <div id="historyList" class="list-group list-group-flush">
                    <!-- Content loaded via JS -->
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <button id="historyPrevPage" class="btn btn-sm btn-outline-secondary" disabled>ä¸Šä¸€é¡µ</button>
                <span id="historyPageInfo" class="small text-muted">ç¬¬ 1 é¡µ</span>
                <button id="historyNextPage" class="btn btn-sm btn-outline-secondary" disabled>ä¸‹ä¸€é¡µ</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        let currentBroadcast = null;
        
        loadLoveOneDayBroadcast();
        
        function loadLoveOneDayBroadcast() {
            const broadcastContent = document.getElementById('broadcastContent');
            const broadcastLoading = document.getElementById('broadcastLoading');
            const broadcastError = document.getElementById('broadcastError');
            const broadcastAudio = document.getElementById('broadcastAudio');
            
            if (!broadcastContent) return;
            
            broadcastLoading.classList.remove('d-none');
            broadcastContent.classList.add('d-none');
            broadcastError.classList.add('d-none');
            broadcastAudio.classList.add('d-none');
            
            fetch('/api/love-one-day/today')
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        currentBroadcast = data.data;
                        broadcastContent.textContent = data.data.text;
                        broadcastLoading.classList.add('d-none');
                        broadcastContent.classList.remove('d-none');
                        
                        if (data.data.audio_url) {
                            broadcastAudio.src = data.data.audio_url;
                            broadcastAudio.classList.remove('d-none');
                        }
                    } else {
                        broadcastLoading.classList.add('d-none');
                        broadcastError.classList.remove('d-none');
                    }
                })
                .catch(err => {
                    console.error('Failed to load love one day broadcast:', err);
                    broadcastLoading.classList.add('d-none');
                    broadcastError.classList.remove('d-none');
                });
        }
        
        document.getElementById('refreshBroadcastBtn').addEventListener('click', function(e) {
            e.preventDefault();
            loadLoveOneDayBroadcast();
        });
        
        document.getElementById('viewHistoryBtn').addEventListener('click', function(e) {
            e.preventDefault();
            loadLoveOneDayHistory();
        });
        
        let historyData = [];
        let historyCurrentPage = 1;
        let historyCurrentOrder = 'desc';
        let historySearchKeyword = '';
        const historyItemsPerPage = 10;
        
        function loadLoveOneDayHistory() {
            const historyModal = new bootstrap.Modal(document.getElementById('historyModal'));
            historyModal.show();
            fetchHistoryData();
        }
        
        function fetchHistoryData() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '<div class="text-center p-3"><div class="spinner-border text-primary" role="status"></div></div>';
            
            let url = `/api/love-one-day/history?page=${historyCurrentPage}&per_page=${historyItemsPerPage}&order=${historyCurrentOrder}`;
            if (historySearchKeyword) {
                url += `&keyword=${encodeURIComponent(historySearchKeyword)}`;
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        historyData = data.data.items;
                        renderHistoryList(data.data);
                    } else {
                        historyList.innerHTML = '<div class="text-center text-danger">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
                    }
                })
                .catch(err => {
                    console.error('Failed to load history:', err);
                    historyList.innerHTML = '<div class="text-center text-danger">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
                });
        }
        
        function renderHistoryList(data) {
            const historyList = document.getElementById('historyList');
            const totalPages = Math.ceil(data.total / historyItemsPerPage);
            
            if (data.items.length === 0) {
                historyList.innerHTML = '<div class="text-center text-muted p-4">æš‚æ— å†å²æ’­æŠ¥</div>';
                document.getElementById('historyPageInfo').textContent = 'ç¬¬ 0 / 0 é¡µ';
                document.getElementById('historyPrevPage').disabled = true;
                document.getElementById('historyNextPage').disabled = true;
                return;
            }
            
            let html = '';
            data.items.forEach(item => {
                const typeBadge = getBroadcastTypeBadge(item.broadcast_type);
                html += `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <span class="badge bg-secondary mb-1">${item.date}</span>
                                ${typeBadge}
                            </div>
                            <small class="text-muted">${item.created_at}</small>
                        </div>
                        <p class="mb-0" style="white-space: pre-wrap; line-height: 1.6;">${item.text}</p>
                    </div>
                `;
            });
            
            historyList.innerHTML = html;
            document.getElementById('historyPageInfo').textContent = `ç¬¬ ${historyCurrentPage} / ${totalPages} é¡µ`;
            document.getElementById('historyPrevPage').disabled = historyCurrentPage === 1;
            document.getElementById('historyNextPage').disabled = historyCurrentPage >= totalPages;
        }
        
        function getBroadcastTypeBadge(type) {
            const typeMap = {
                'anniversary': '<span class="badge bg-danger">ğŸ’• çºªå¿µæ—¥</span>',
                'historical_moments': '<span class="badge bg-info">ğŸ“¸ å†å²æ—¥å¸¸</span>',
                'historical_events': '<span class="badge bg-warning">ğŸ—“ï¸ å†å²è¶£äº‹</span>'
            };
            return typeMap[type] || '<span class="badge bg-secondary">æœªçŸ¥</span>';
        }
        
        document.getElementById('historySortOrder').addEventListener('change', function(e) {
            historyCurrentOrder = e.target.value;
            historyCurrentPage = 1;
            fetchHistoryData();
        });
        
        document.getElementById('historySearchInput').addEventListener('input', function(e) {
            historySearchKeyword = e.target.value.trim();
            historyCurrentPage = 1;
            fetchHistoryData();
        });
        
        document.getElementById('historyPrevPage').addEventListener('click', function() {
            if (historyCurrentPage > 1) {
                historyCurrentPage--;
                fetchHistoryData();
            }
        });
        
        document.getElementById('historyNextPage').addEventListener('click', function() {
            historyCurrentPage++;
            fetchHistoryData();
        });
        
        document.getElementById('playAudioBtn').addEventListener('click', function(e) {
            e.preventDefault();
            const broadcastAudio = document.getElementById('broadcastAudio');
            if (currentBroadcast && currentBroadcast.audio_url) {
                broadcastAudio.play();
            } else if (currentBroadcast) {
                generateAudio(currentBroadcast);
            } else {
                alert('è¯·å…ˆåŠ è½½æ’­æŠ¥å†…å®¹');
            }
        });
        
        function generateAudio(broadcast) {
            const playAudioBtn = document.getElementById('playAudioBtn');
            playAudioBtn.textContent = 'ğŸ”Š ç”Ÿæˆä¸­...';
            playAudioBtn.disabled = true;
            
            fetch('/api/love-one-day/tts', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    text: broadcast.text,
                    report_id: broadcast.id
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    currentBroadcast.audio_url = data.data.audio_url;
                    const broadcastAudio = document.getElementById('broadcastAudio');
                    broadcastAudio.src = data.data.audio_url;
                    broadcastAudio.classList.remove('d-none');
                    broadcastAudio.play();
                } else {
                    alert('è¯­éŸ³ç”Ÿæˆå¤±è´¥: ' + data.msg);
                }
            })
            .catch(err => {
                console.error('Failed to generate audio:', err);
                alert('è¯­éŸ³ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            })
            .finally(() => {
                playAudioBtn.textContent = 'ğŸ”Š æ’­æ”¾è¯­éŸ³';
                playAudioBtn.disabled = false;
            });
        }
        
        // --- Pinned Moments Logic ---
        function initPinnedMoments() {
            const unpinButtons = document.querySelectorAll('.unpin-btn');
            const pinnedCountBadge = document.getElementById('pinnedCountBadge');
            const pinnedMomentCards = document.querySelectorAll('.pinned-moment-card');
            
            // Update pinned count badge
            const pinnedCount = document.querySelectorAll('.pinned-moment-card').length;
            if (pinnedCountBadge) {
                pinnedCountBadge.textContent = `ç½®é¡¶ ${pinnedCount}/3`;
            }
            
            // Add click event to pinned moment cards for navigation
            pinnedMomentCards.forEach(card => {
                card.addEventListener('click', function(e) {
                    // Don't navigate if clicking on unpin button
                    if (e.target.classList.contains('unpin-btn') || e.target.closest('.unpin-btn')) {
                        return;
                    }
                    
                    const momentId = this.dataset.momentId;
                    if (momentId) {
                        window.location.href = `/moments?moment_id=${momentId}`;
                    }
                });
            });
            
            // Add event listeners to unpin buttons
            unpinButtons.forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const momentCard = this.closest('.pinned-moment-card');
                    const momentId = momentCard.dataset.momentId;
                    
                    fetch(`/moments/${momentId}/unpin`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'}
                    })
                    .then(res => res.json())
                    .then(res => {
                        if (res.code === 200) {
                            momentCard.remove();
                            const newCount = document.querySelectorAll('.pinned-moment-card').length;
                            if (pinnedCountBadge) {
                                pinnedCountBadge.textContent = `ç½®é¡¶ ${newCount}/3`;
                            }
                            
                            // Show empty message if no pinned moments
                            if (newCount === 0) {
                                const pinnedList = document.getElementById('pinnedMomentsList');
                                pinnedList.innerHTML = `
                                    <div class="text-center text-muted py-3 small">
                                        æš‚æ— ç½®é¡¶æ—¥å¸¸ï¼Œç‚¹å‡»"å†™æ—¥è®°"åå¯ç½®é¡¶é‡è¦å†…å®¹
                                    </div>
                                `;
                            }
                        } else {
                            alert(res.msg || 'å–æ¶ˆç½®é¡¶å¤±è´¥');
                        }
                    })
                    .catch(err => {
                        console.error('Failed to unpin moment:', err);
                        alert('å–æ¶ˆç½®é¡¶å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    });
                });
            });
        }
        
        // Initialize pinned moments on page load
        initPinnedMoments();
        
        // --- Add Anniversary Logic ---
        const btn = document.getElementById('addAnniversaryBtn');
        const modalEl = document.getElementById('addAnniversaryModal');
        
        if (btn && modalEl) {
            btn.addEventListener('click', function() {
                if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                    try {
                        const modal = new bootstrap.Modal(modalEl);
                        modal.show();
                    } catch (e) {
                        console.error('Modal initialization failed:', e);
                    }
                }
            });
        }

        // --- Show More Logic (Frontend Pagination) ---
        const showMoreBtn = document.getElementById('showMoreBtn');
        const allModalEl = document.getElementById('allAnniversariesModal');
        let allAnniversaries = [];
        let currentPage = 1;
        const itemsPerPage = 8;  // æ¯é¡µæ˜¾ç¤º8æ¡
        let currentOrder = 'desc';

        if (showMoreBtn && allModalEl) {
            const allModal = new bootstrap.Modal(allModalEl);
            const listEl = document.getElementById('allAnniversariesList');
            
            showMoreBtn.addEventListener('click', () => {
                allModal.show();
                fetchAllAnniversaries();
            });

            document.getElementById('sortOrder').addEventListener('change', (e) => {
                currentOrder = e.target.value;
                sortAnniversaries();
                currentPage = 1;
                renderPage();
            });

            document.getElementById('prevPage').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderPage();
                }
            });

            document.getElementById('nextPage').addEventListener('click', () => {
                if (currentPage * itemsPerPage < allAnniversaries.length) {
                    currentPage++;
                    renderPage();
                }
            });

            // Keyboard Navigation
            document.addEventListener('keydown', (e) => {
                if (allModalEl.classList.contains('show')) {
                    if (e.key === 'ArrowLeft' && currentPage > 1) {
                        currentPage--;
                        renderPage();
                    } else if (e.key === 'ArrowRight' && currentPage * itemsPerPage < allAnniversaries.length) {
                        currentPage++;
                        renderPage();
                    }
                }
            });

            // Swipe Navigation
            let touchStartX = 0;
            let touchEndX = 0;
            
            allModalEl.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
            });

            allModalEl.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            });

            function handleSwipe() {
                if (touchEndX < touchStartX - 50) { // Swipe Left -> Next
                    if (currentPage * itemsPerPage < allAnniversaries.length) {
                        currentPage++;
                        renderPage();
                    }
                }
                if (touchEndX > touchStartX + 50) { // Swipe Right -> Prev
                    if (currentPage > 1) {
                        currentPage--;
                        renderPage();
                    }
                }
            }

            function fetchAllAnniversaries() {
                listEl.innerHTML = '<div class="text-center p-3"><div class="spinner-border text-danger" role="status"></div></div>';
                
                // Fetch ALL items using per_page=-1
                fetch(`/api/anniversaries?per_page=-1&order=${currentOrder}`)
                    .then(response => response.json())
                    .then(data => {
                        allAnniversaries = data.items;
                        sortAnniversaries(); // Ensure client-side sort matches
                        currentPage = 1;
                        renderPage();
                    })
                    .catch(err => {
                        console.error('Failed to load anniversaries:', err);
                        listEl.innerHTML = '<div class="text-center text-danger">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
                    });
            }

            function sortAnniversaries() {
                allAnniversaries.sort((a, b) => {
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);
                    // Use id as tie-breaker if dates are equal, but here we just use date
                    return currentOrder === 'asc' ? dateA - dateB : dateB - dateA;
                });
            }

            function renderPage() {
                const start = (currentPage - 1) * itemsPerPage;
                const end = start + itemsPerPage;
                const pageItems = allAnniversaries.slice(start, end);
                const totalPages = Math.ceil(allAnniversaries.length / itemsPerPage);

                // Add simple fade animation
                listEl.style.opacity = '0';
                
                setTimeout(() => {
                    listEl.innerHTML = '';
                    pageItems.forEach(item => {
                        const li = document.createElement('div');
                        li.className = 'list-group-item d-flex justify-content-between align-items-center';
                        li.innerHTML = `
                            <div>
                                <strong>${item.title}</strong>
                                <div class="small text-muted">${item.date}</div>
                            </div>
                            <div>
                                <span class="badge bg-danger rounded-pill mb-1">${item.days_count} å¤©</span>
                            </div>
                        `;
                        listEl.appendChild(li);
                    });
                    
                    listEl.style.opacity = '1';
                    listEl.style.transition = 'opacity 0.2s ease-in-out';

                    document.getElementById('pageInfo').textContent = `ç¬¬ ${currentPage} / ${totalPages} é¡µ`;
                    document.getElementById('prevPage').disabled = currentPage === 1;
                    document.getElementById('nextPage').disabled = currentPage >= totalPages;
                }, 100);
            }
        }
    });
</script>
{% endblock %}