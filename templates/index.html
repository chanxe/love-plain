{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12 text-center mb-5">
        <h1 class="display-4 fw-bold text-danger">æ¬¢è¿å›åˆ°æˆ‘ä»¬çš„äºŒäººä¸–ç•Œ â¤ï¸</h1>
        <p class="lead text-muted">è®°å½•æ¯ä¸€ä¸ªå¿ƒåŠ¨ç¬é—´ï¼Œçè—æ¯ä¸€ä»½å›å¿†</p>
    </div>
</div>

<div class="row">
    <!-- çºªå¿µæ—¥æ¿å— -->
    <div class="col-md-4">
        <div class="card love-card mb-4 shadow-sm border-0 h-100">
            <div class="card-body text-center">
                <div class="mb-3 display-1">ğŸ“…</div>
                <h3 class="card-title">
                    çºªå¿µæ—¥ 
                    <span class="badge bg-light text-dark rounded-pill fs-6 align-middle" title="å½“å‰æ€»æ•°">
                        {{ total_count if total_count is defined else '?' }}
                    </span>
                </h3>
                <p class="card-text text-muted">ä¸è¦å¿˜è®°é‡è¦çš„æ—¥å­</p>
                <ul id="anniversary-list" class="list-group list-group-flush text-start mb-3">
                    {% for anniversary in anniversaries %}
                    <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent">
                        <div>
                            <strong>{{ anniversary.title }}</strong>
                            <div class="small text-muted">{{ anniversary.date }}</div>
                        </div>
                        <div>
                            <span class="badge bg-danger rounded-pill mb-1">{{ anniversary.days_count }} å¤©</span>
                            <a href="/anniversaries/delete/{{ anniversary.id }}" class="btn btn-sm btn-outline-secondary border-0 text-muted px-1">Ã—</a>
                        </div>
                    </li>
                    {% else %}
                    <li class="list-group-item text-muted bg-transparent text-center">æš‚æ— çºªå¿µæ—¥</li>
                    {% endfor %}
                </ul>
                
                {% if total_count > 5 %}
                <button id="showMoreBtn" class="btn btn-outline-secondary w-100 mb-2">
                    æŸ¥çœ‹å…¨éƒ¨ ({{ total_count }})
                </button>
                {% endif %}

                <!-- æ·»åŠ çºªå¿µæ—¥æŒ‰é’® -->
                <button id="addAnniversaryBtn" class="btn btn-outline-danger w-100">
                    + æ·»åŠ çºªå¿µæ—¥
                </button>
            </div>
        </div>
    </div>
    
    <!-- æ—¥å¸¸åŠ¨æ€æ¿å— -->
    <div class="col-md-4">
        <div class="card love-card mb-4 shadow-sm border-0 h-100">
            <div class="card-body text-center">
                <div class="mb-3 display-1">ğŸ“</div>
                <h3 class="card-title">æ‹çˆ±æ—¥å¸¸</h3>
                <p class="card-text text-muted">ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆæœ‰è¶£çš„äº‹ï¼Ÿ</p>
                <a href="/moments" class="btn btn-primary w-100">å†™æ—¥è®° / å‘åŠ¨æ€</a>
            </div>
        </div>
    </div>

    <!-- èŠå¤©æ¿å— -->
    <div class="col-md-4">
        <div class="card love-card mb-4 shadow-sm border-0 h-100">
            <div class="card-body text-center">
                <div class="mb-3 display-1">ğŸ’¬</div>
                <h3 class="card-title">äº²å¯†èŠå¤©</h3>
                <p class="card-text text-muted">æƒ³ä½ äº†ï¼Œå‘ä¸ªæ¶ˆæ¯å§</p>
                <a href="/chat" class="btn btn-success w-100">è¿›å…¥èŠå¤©å®¤</a>
            </div>
        </div>
    </div>
</div>

<!-- Modal: æŸ¥çœ‹å…¨éƒ¨çºªå¿µæ—¥ -->
<div class="modal fade" id="allAnniversariesModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">å…¨éƒ¨çºªå¿µæ—¥</h5>
                <div class="ms-auto me-2">
                    <select id="sortOrder" class="form-select form-select-sm">
                        <option value="desc">æ·»åŠ æ—¶é—´å€’åº</option>
                        <option value="asc">æ·»åŠ æ—¶é—´æ­£åº</option>
                    </select>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="allAnniversariesList" class="list-group list-group-flush">
                    <!-- Content loaded via JS -->
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <button id="prevPage" class="btn btn-sm btn-outline-secondary" disabled>ä¸Šä¸€é¡µ</button>
                <span id="pageInfo" class="small text-muted">ç¬¬ 1 é¡µ</span>
                <button id="nextPage" class="btn btn-sm btn-outline-secondary" disabled>ä¸‹ä¸€é¡µ</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: æ·»åŠ çºªå¿µæ—¥ -->
<div class="modal fade" id="addAnniversaryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">æ·»åŠ çºªå¿µæ—¥</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="/anniversaries/add" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">æ ‡é¢˜</label>
                        <input type="text" name="title" class="form-control" placeholder="ä¾‹å¦‚ï¼šåœ¨ä¸€èµ·" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">æ—¥æœŸ</label>
                        <input type="date" name="date" class="form-control" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-danger">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Add Anniversary Logic ---
        const btn = document.getElementById('addAnniversaryBtn');
        const modalEl = document.getElementById('addAnniversaryModal');
        
        if (btn && modalEl) {
            btn.addEventListener('click', function() {
                if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                    try {
                        const modal = new bootstrap.Modal(modalEl);
                        modal.show();
                    } catch (e) {
                        console.error('Modal initialization failed:', e);
                    }
                }
            });
        }

        // --- Show More Logic (Frontend Pagination) ---
        const showMoreBtn = document.getElementById('showMoreBtn');
        const allModalEl = document.getElementById('allAnniversariesModal');
        let allAnniversaries = [];
        let currentPage = 1;
        const itemsPerPage = 5;
        let currentOrder = 'desc';

        if (showMoreBtn && allModalEl) {
            const allModal = new bootstrap.Modal(allModalEl);
            const listEl = document.getElementById('allAnniversariesList');
            
            showMoreBtn.addEventListener('click', () => {
                allModal.show();
                fetchAllAnniversaries();
            });

            document.getElementById('sortOrder').addEventListener('change', (e) => {
                currentOrder = e.target.value;
                sortAnniversaries();
                currentPage = 1;
                renderPage();
            });

            document.getElementById('prevPage').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderPage();
                }
            });

            document.getElementById('nextPage').addEventListener('click', () => {
                if (currentPage * itemsPerPage < allAnniversaries.length) {
                    currentPage++;
                    renderPage();
                }
            });

            // Keyboard Navigation
            document.addEventListener('keydown', (e) => {
                if (allModalEl.classList.contains('show')) {
                    if (e.key === 'ArrowLeft' && currentPage > 1) {
                        currentPage--;
                        renderPage();
                    } else if (e.key === 'ArrowRight' && currentPage * itemsPerPage < allAnniversaries.length) {
                        currentPage++;
                        renderPage();
                    }
                }
            });

            // Swipe Navigation
            let touchStartX = 0;
            let touchEndX = 0;
            
            allModalEl.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
            });

            allModalEl.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            });

            function handleSwipe() {
                if (touchEndX < touchStartX - 50) { // Swipe Left -> Next
                    if (currentPage * itemsPerPage < allAnniversaries.length) {
                        currentPage++;
                        renderPage();
                    }
                }
                if (touchEndX > touchStartX + 50) { // Swipe Right -> Prev
                    if (currentPage > 1) {
                        currentPage--;
                        renderPage();
                    }
                }
            }

            function fetchAllAnniversaries() {
                listEl.innerHTML = '<div class="text-center p-3"><div class="spinner-border text-danger" role="status"></div></div>';
                
                // Fetch ALL items using per_page=-1
                fetch(`/api/anniversaries?per_page=-1&order=${currentOrder}`)
                    .then(response => response.json())
                    .then(data => {
                        allAnniversaries = data.items;
                        sortAnniversaries(); // Ensure client-side sort matches
                        currentPage = 1;
                        renderPage();
                    })
                    .catch(err => {
                        console.error('Failed to load anniversaries:', err);
                        listEl.innerHTML = '<div class="text-center text-danger">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
                    });
            }

            function sortAnniversaries() {
                allAnniversaries.sort((a, b) => {
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);
                    // Use id as tie-breaker if dates are equal, but here we just use date
                    return currentOrder === 'asc' ? dateA - dateB : dateB - dateA;
                });
            }

            function renderPage() {
                const start = (currentPage - 1) * itemsPerPage;
                const end = start + itemsPerPage;
                const pageItems = allAnniversaries.slice(start, end);
                const totalPages = Math.ceil(allAnniversaries.length / itemsPerPage);

                // Add simple fade animation
                listEl.style.opacity = '0';
                
                setTimeout(() => {
                    listEl.innerHTML = '';
                    pageItems.forEach(item => {
                        const li = document.createElement('div');
                        li.className = 'list-group-item d-flex justify-content-between align-items-center';
                        li.innerHTML = `
                            <div>
                                <strong>${item.title}</strong>
                                <div class="small text-muted">${item.date}</div>
                            </div>
                            <div>
                                <span class="badge bg-danger rounded-pill mb-1">${item.days_count} å¤©</span>
                            </div>
                        `;
                        listEl.appendChild(li);
                    });
                    
                    listEl.style.opacity = '1';
                    listEl.style.transition = 'opacity 0.2s ease-in-out';

                    document.getElementById('pageInfo').textContent = `ç¬¬ ${currentPage} / ${totalPages} é¡µ`;
                    document.getElementById('prevPage').disabled = currentPage === 1;
                    document.getElementById('nextPage').disabled = currentPage >= totalPages;
                }, 100);
            }
        }
    });
</script>
{% endblock %}
