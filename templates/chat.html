{% extends "base.html" %}

{% block content %}
<style>
    .chat-container {
        height: 70vh;
        display: flex;
        flex-direction: column;
    }
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        background-color: #f1f3f5;
        border-radius: 0.5rem;
        display: flex;
        flex-direction: column;
    }
    .message-bubble {
        max-width: 70%;
        padding: 0.8rem 1rem;
        border-radius: 1rem;
        margin-bottom: 0.8rem;
        position: relative;
        word-wrap: break-word;
    }
    .message-left {
        align-self: flex-start;
        background-color: white;
        border-bottom-left-radius: 0.2rem;
    }
    .message-right {
        align-self: flex-end;
        background-color: #d63384; /* Bootstrap pink-ish or custom love color */
        color: white;
        border-bottom-right-radius: 0.2rem;
    }
    .message-info {
        font-size: 0.75rem;
        margin-bottom: 0.2rem;
        color: #6c757d;
    }
    .message-right .message-info {
        color: #e9ecef;
        text-align: right;
    }
    .status-bar {
        height: 20px;
        font-size: 0.8rem;
        color: #6c757d;
        text-align: center;
    }
    .typing-indicator::after {
        content: '...';
        animation: ellipsis 1.5s infinite;
    }
    @keyframes ellipsis {
        0% { content: '.'; }
        33% { content: '..'; }
        66% { content: '...'; }
    }
</style>

<div class="row mb-3">
    <div class="col-12 d-flex justify-content-between align-items-center">
        <h2 class="text-danger">ğŸ’¬ äº²å¯†èŠå¤©</h2>
        <div class="d-flex align-items-center">
            <span class="me-2">æˆ‘æ˜¯:</span>
            <select id="currentUserSelect" class="form-select form-select-sm" style="width: auto;">
                <option value="1">Boy</option>
                <option value="2">Girl</option>
            </select>
            <span id="connectionStatus" class="badge bg-secondary ms-3">æœªè¿æ¥</span>
        </div>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-header bg-white">
        <div id="chatStatus" class="status-bar"></div>
    </div>
    <div class="card-body p-0">
        <div class="chat-container">
            <div id="messagesList" class="chat-messages">
                <!-- Messages will be inserted here -->
            </div>
            <div class="p-3 bg-white border-top">
                <div class="input-group">
                    <input type="text" id="messageInput" class="form-control" placeholder="è¾“å…¥æ¶ˆæ¯..." autocomplete="off">
                    <button class="btn btn-primary" id="sendBtn">å‘é€</button>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const socket = io();
        const messagesList = document.getElementById('messagesList');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const userSelect = document.getElementById('currentUserSelect');
        const connectionStatus = document.getElementById('connectionStatus');
        const chatStatus = document.getElementById('chatStatus');
        
        let currentUserId = parseInt(userSelect.value);
        let typingTimeout = null;

        // User Selection Change
        userSelect.addEventListener('change', (e) => {
            currentUserId = parseInt(e.target.value);
            // Reload history to refresh side (left/right)
            loadHistory();
        });

        // Socket Connection
        socket.on('connect', () => {
            connectionStatus.textContent = 'åœ¨çº¿';
            connectionStatus.className = 'badge bg-success ms-3';
            socket.emit('join', { room: 'couple_room' });
        });

        socket.on('disconnect', () => {
            connectionStatus.textContent = 'æ–­å¼€';
            connectionStatus.className = 'badge bg-danger ms-3';
        });

        // Receive Message
        socket.on('response', (data) => {
            appendMessage(data);
            scrollToBottom();
            // If message is from other, clear typing status
            if (data.sender_id !== currentUserId) {
                chatStatus.textContent = '';
            }
        });
        
        // Message Recalled
        socket.on('message_recalled', (data) => {
            const el = document.getElementById(`msg-${data.id}`);
            if (el) {
                const notice = document.createElement('div');
                notice.className = 'text-center text-muted small my-2';
                notice.innerText = 'ä¸€æ¡æ¶ˆæ¯è¢«æ’¤å›';
                el.parentNode.insertBefore(notice, el);
                el.remove();
            }
        });

        // Status Change (Typing)
        socket.on('status_change', (data) => {
            if (data.status === 'typing') {
                chatStatus.textContent = 'å¯¹æ–¹æ­£åœ¨è¾“å…¥...';
            } else {
                chatStatus.textContent = '';
            }
        });

        // Send Message
        function sendMessage() {
            const content = messageInput.value.trim();
            if (!content) return;

            socket.emit('message', {
                content: content,
                sender_id: currentUserId,
                room: 'couple_room'
            });

            messageInput.value = '';
            socket.emit('stop_typing', { sender_id: currentUserId, room: 'couple_room' });
        }

        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // Typing Indicator
        messageInput.addEventListener('input', () => {
            socket.emit('typing', { sender_id: currentUserId, room: 'couple_room' });
            
            if (typingTimeout) clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                socket.emit('stop_typing', { sender_id: currentUserId, room: 'couple_room' });
            }, 1000);
        });

        // Load History
        async function loadHistory() {
            try {
                const res = await fetch('/api/chat/history?limit=50');
                const data = await res.json();
                messagesList.innerHTML = '';
                // API returns desc (newest first). We need to reverse to show oldest at top.
                const items = data.items.reverse(); 
                items.forEach(msg => appendMessage(msg));
                scrollToBottom();
            } catch (err) {
                console.error('Failed to load history', err);
            }
        }

        function appendMessage(msg) {
            const isSelf = msg.sender_id === currentUserId;
            const div = document.createElement('div');
            div.id = `msg-${msg.id}`;
            div.className = `message-bubble ${isSelf ? 'message-right' : 'message-left'}`;
            
            // Time formatting (simple)
            const time = new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            let recallHtml = '';
            if (isSelf) {
                 recallHtml = `<span class="recall-btn ms-2" style="cursor:pointer; opacity: 0.7;" title="æ’¤å›">â†©ï¸</span>`;
            }

            div.innerHTML = `
                <div class="message-info">
                    ${isSelf ? 'æˆ‘' : msg.sender_name} ${time}
                    ${recallHtml}
                </div>
                <div class="message-content">${escapeHtml(msg.content)}</div>
            `;
            
            if (isSelf) {
                const btn = div.querySelector('.recall-btn');
                if (btn) {
                    btn.onclick = () => {
                        if(confirm('ç¡®å®šæ’¤å›è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ')) {
                            socket.emit('recall', { id: msg.id, sender_id: currentUserId, room: 'couple_room' });
                        }
                    };
                }
            }

            messagesList.appendChild(div);
        }

        function scrollToBottom() {
            messagesList.scrollTop = messagesList.scrollHeight;
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        // Initial Load
        loadHistory();
    });
</script>
{% endblock %}
